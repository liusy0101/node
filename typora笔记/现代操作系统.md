[toc]



# 现代操作系统



## 一、综述

### 1、什么是操作系统

操作系统是一种运行在内核态的软件。

由于硬件的接口极为复杂，所以操作系统的一个主要任务是隐藏硬件，呈现给程序一个良好、清晰、一致的抽象。

现代计算机包含处理器、存储器、时钟、磁盘、网络接口等许多设备，操作系统需要在互相竞争的程序之间有序地控制堆处理器、存储器以及其它IO接口设备的分配。

在多进程和多用户的环境中，操作系统需要记录哪些程序在使用什么资源，对资源请求进行分配，评估使用代价，并为不同的程序和用户之间调解相互冲突的资源请求。

资源管理用两种不同方式实现**多路复用（共享）**资源：在时间上复用和在空间上复用。

- **时间上复用：** 不同程序或用户轮流使用，时间片分割
- **空间上复用：** 都获取一部分资源，取代排队。





### 2、计算机硬件

![image-20210718160025872](typora-user-images/image-20210718160025872.png)

CPU、内存以及IO设备都由一条系统总线连接起来并通过总线与其它设备通信。



#### （1）处理器

CPU从内存中取出指令并执行。

**CPU指令周期：**

- 从内存中取出指令
- 解码，确定类型和操作数
- 执行
- 将结果暂存寄存器



每个CPU都有一套专门指令集，所以，x86处理器不能执行ARM程序，ARM处理器也不能执行x86程序。



**寄存器：**

用来访问内存以得到指令或数据的时间要比执行指令花费的时间长的多，所以，CPU内部会有用来保存关键变量和临时数据的寄存器。

通常在指令集中提供了一些指令，用来将数据从内存读入寄存器，从寄存器读入内存，其它指令可以把来自寄存器、内存的操作数进行计算，将产生的结果存在寄存器或内存中。



**程序计数器：**

也是寄存器，保存了将要取出的下一条指令的内存地址。在指令取出之后，程序计数器就被更新以便指向后继的指令。



**堆栈指针：**

也是寄存器，指向内存中当前栈的顶端。该栈包含了每个执行过程的栈帧。一个过程的栈帧中保存了有关的输入参数、局部变量以及哪些没有保存在寄存器这种的临时变量。



**程序状态字（Program Status Word，PSW）：**

这个寄存器包含了条件码位、CPU优先级、模式（用户态或内核态），以及各种其它控制位。用户程序通常读入整个PSW，但是，只对其中的少量字段写入。在系统调用和IO中，PSW的作用很重要。



操作系统必须知晓所有寄存器，在时间多路复用CPU中，操作系统经常会终止某个进程并启动另一个进程，此时操作系统需要保存所有的寄存器值，以便在后面再次运行该进程时，重新装入这些寄存器，恢复之前状态。



现代CPU具有同时取出多条指令的机制。例如一个CPU可以有单独的取指单元、解码单元和执行单元，当执行指令n时，可解码n+1指令，读取n+2指令，这种成为**流水线**

![image-20210718162243960](typora-user-images/image-20210718162243960.png)



超标量CPU中有多个执行单元，例如一个CPU用于整数计算、一个CPU用于浮点计算、一个CPU用于布尔运算，两个或更多的指令被同时取出、解码并装入暂存缓冲区中，直至它们执行完成。只要有一个执行单元空间，就检查保持缓冲区中是否还有可处理的指令，有则把指令冲缓冲区中移出并执行。



CPU会有两种模式：**内核态**和**用户态**

在PSW中有一个二进制位控制这两种模式，当在内核态运行时，CPU可执行指令集中的每一条指令，并使用硬件的每种功能。操作系统就运行在内核态中

用户程序在用户态下运行，仅允许执行整个指令集的一个子集或访问所有功能的一个子集。

如果用户程序想要从操作系统中获取服务，用户程序必须使用**系统调用**以陷入内核并调用操作系统。

**TRAP**指令把用户态切换成内核态，并启用操作系统，完成后，在系统调用后面的指令把控制权返回给用户程序。



**多线程和多核芯片：**

多线程允许CPU保持两个不同的线程状态，然后在纳秒级的时间尺度内来回切换。

如果某个进程需要从内存中读出一个字（需要花费多个时钟周期），多线程CPU则可切换至另一个线程。多线程不提供真正的并行处理。在某个时刻只有一个进程在运行，单=但线程的切换时间则减少到纳秒数量级。

多核CPU

![image-20210718163820587](typora-user-images/image-20210718163820587.png)

**GPU：** 由成千上万个微核组成的处理器，擅长处理大量并行的简单运算。





#### （2）存储器

存储器系统采用分层次的结构。

![image-20210718164303870](typora-user-images/image-20210718164303870.png)

**寄存器：**

用于CPU相同材料制成，跟CPU一样快。存储容量在32位CPU中是32*32位，在64位CPU中是64\*64位。



**高速缓存行：**

多数由硬件控制，主存被分割成高速缓存行，典型大小为64字节，地址0~63对应高速缓存行0，64~127对应高速缓存行1 。

最常用的高速缓存行放置在CPU内部或非常接近CPU的高速缓存中。

当程序需要读一个存储字时，高速缓存组件检查是否在高速缓存中，如果是，则称为高速缓存命中。缓存满足了请求，就不需要将访问请求送往贮存。

高速缓存命中一般需要两个时钟周期，未命中就必须访问内存，需要大量时间。



现代CPU中设计了两个缓存。

**L1缓存：**

在CPU中，通常用来将已解码的指令调入CPU的执行引擎



**L2缓存：**

存放频繁使用的数据字。



L1、L2缓存之间的差别在于时序，对L1缓存的访问，不存在延时，对L2缓存的访问，则会延时1或2个时钟周期。



**主存：**

存储器系统主力，称为随机访问存储器。





#### （3）磁盘

磁盘随机访问数据时间比内存大约慢了三个数量级。也就是慢了1000倍左右。



**虚拟内存机制：**

使期望运行大于物理内存的程序成为可能，其方法是将程序放在磁盘上，将主存作为一种缓存，用来保存最频繁使用的部分程序。

需要快速地映射内存地址，以便将程序生成的地址转换为有关字节在RAM中的物理地址。

这种映射由CPU中的**存储器管理单元**（Memory Management Unit，MMU）来完成。





#### （4）I/O设备

I/O设备一般包括两个部分：设备控制器核设备本身。

控制器是插在电路板上的一块芯片或一组芯片，这块电路板物理地控制设备，从操作系统接受命令。

实现输入、输出的方式由三种：

**1、忙等待**

用户程序发出一个系统调用，内核将其解析成一个对应设备驱动程序的过程调用，然后设备驱动程序启动IO并在一个连续不断的循环中检查该设备，看是否完成了，当IO结束后，设备驱动程序把数据送到指定的地方并返回。然后操作系统将控制权返回给调用者。



**2、中断**

设备驱动程序启动设备并让该设备在操作完成时发出一个中断。设备驱动程序在这个时刻返回，操作系统在需要时阻塞调用者并安排其它工作进行。当设备驱动程序检测到该设备的操作完毕后，发出一个中断通知操作完成。





![image-20210718171351381](typora-user-images/image-20210718171351381.png)

在操作系统中，中断是非常重要的。

一旦CPU决定取中断，通常程序计数器和PSW就被压入当前堆栈，并切换回用户态。设备编号可成为部分内存的一个引用，用于寻找该设备中断处理程序的地址，这部分内存称为**中断向量**



**3、DMA**

直接存储器访问。

在进行IO设备和内存的数据传输的时候，数据搬运的工作全部交给DMA控制，而CPU不在参与任何与数据搬运相关的事情，此时就能释放CPU资源去处理其他事务。





#### （5）总线

CPU和内存以及其它设备之间，也需要通信，因此用这种特殊的设备进行控制，就是总线。

总线分成3种：

- 地址总线，专门用来指定CPU将要操作的内存地址
- 数据总线，用来读写内存中的数据
- 控制总线，用来发送和接受关键信号，比如中断信号、设备复位等信号，都是通过控制总线传输，同样，CPU需要堆这些信号进行响应，也需要控制总线。

当CPU需要读写内存的时候，先要通过地址总线来指定内存地址，再通过数据总线来传输数据。





#### （6）启动计算机

计算机中有一块双亲板，双亲版上有一个称为**基本输入输出系统（Basic Input Output System，BIOS）**的程序

BIOS内有底层IO软件，包括读键盘、写屏幕、进行磁盘IO以及其它过程。

计算机启动时，BIOS开始运行，首先检查所安装的RAM数量，键盘和其它基本设备是否已安装并正常响应。然后，开始扫描PCIe和PCI总线并找出连在上面的所有设备，即插即用设备也被记录下来。如果现有的设备和系统上一次启动时的设备不同，则新的设备将被配置。

然后，BIOS尝试存储在CMOS存储器中的设备清单决定启动设备，用户可进行BIOS进行启动设备的设置。

然后，操作系统询问BIOS，获取配置信息。